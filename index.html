<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pac-Man Game</title>
    <style>

        html {
    touch-action: manipulation; /* Отключает double-tap zoom */
    -webkit-text-size-adjust: 100%; /* Для Safari */
}

body {
    touch-action: manipulation;
    -webkit-touch-callout: none; /* Отключает контекстное меню */
    -webkit-user-select: none; /* Отключает выделение текста */
    user-select: none;
}

/* Специально для кнопок управления */
.arrow-btn {
    touch-action: manipulation;
    -webkit-touch-callout: none;
    -webkit-tap-highlight-color: transparent; /* Убирает подсветку при тапе */
}

        body {
            margin: 0;
            padding: 20px;
            background: #000;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Добавить эту строку */
            box-sizing: border-box; /* И эту для правильного расчета размеров */
        }

        .game-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 360px;
            width: 100%;
            border-radius: 16px;
        }

        .game-field {
            width: 360px;
            height: 400px;
            background: #092B1A;
            border: 3px solid #0B4F2D;
            position: relative;
            overflow: hidden;
            border-radius: 16px;
        }

        .maze {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* Горизонтальные стены */
        .wall-h {
            position: absolute;
            height: 4px;
            background: #0B4F2D;
            border-radius: 4px;
        }

        /* Вертикальные стены */
        .wall-v {
            position: absolute;
            width: 4px;
            background: #0B4F2D;
            border-radius: 4px;
        }

        /* Внешние стены */
        .outer-wall-top { top: 20px; left: 20px; right: 20px; }
        .outer-wall-bottom { bottom: 20px; left: 20px; right: 20px; }
        .outer-wall-left { top: 20px; left: 20px; bottom: 20px; }
        .outer-wall-right { top: 20px; right: 20px; bottom: 20px; }

        /* Внутренние стены - создаем лабиринт */
        .inner-wall-1 { top: 60px; left: 60px; width: 80px; }
        .inner-wall-2 { top: 60px; right: 60px; width: 80px; }
        .inner-wall-3 { top: 60px; left: 60px; height: 80px; }
        .inner-wall-4 { top: 60px; right: 60px; height: 80px; }
        
        .inner-wall-5 { top: 120px; left: 140px; width: 80px; }
        .inner-wall-6 { top: 180px; left: 140px; height: 40px; }
        .inner-wall-7 { top: 180px; right: 140px; height: 40px; }
        
        .inner-wall-8 { top: 260px; left: 60px; height: 80px; }
        .inner-wall-9 { top: 260px; right: 60px; height: 80px; }
        
        .inner-wall-10 { top: 338px; left: 60px; width: 80px; }
        .inner-wall-11 { top: 338px; right: 60px; width: 80px; }
        
        .inner-wall-12 { top: 280px; left: 140px; width: 80px; }

        .pacman {
            position: absolute;
            width: 28px;
            height: 28px;
            background-image: url('./images/Watermelon.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 10;
            transition: none;
            transform-origin: center center;
        }

        /* Поворот спрайта в зависимости от направления */
        .pacman.right { transform: rotate(0deg); }
        .pacman.left { transform: rotate(180deg); }
        .pacman.up { transform: rotate(-90deg); }
        .pacman.down { transform: rotate(90deg); }

/* Анимация "дыхания" для Pac-Man */
@keyframes pacman-breathing {
    0% { transform: scale(1); }
    50% { transform: scale(0.9); }
    100% { transform: scale(1); }
}
@keyframes pacman-breathing-right {
    0% { transform: scaleX(1) scale(1); }
    50% { transform: scaleX(1) scale(0.9); }
    100% { transform: scaleX(1) scale(1); }
}
@keyframes pacman-breathing-left {
    0% { transform: scaleX(-1) scale(1); }
    50% { transform: scaleX(-1) scale(0.9); }
    100% { transform: scaleX(-1) scale(1); }
}
@keyframes pacman-breathing-up {
    0% { transform: rotate(-90deg) scale(1); }
    50% { transform: rotate(-90deg) scale(0.9); }
    100% { transform: rotate(-90deg) scale(1); }
}
@keyframes pacman-breathing-down {
    0% { transform: rotate(90deg) scale(1); }
    50% { transform: rotate(90deg) scale(0.9); }
    100% { transform: rotate(90deg) scale(1); }
}

/* Дыхание работает только БЕЗ неуязвимости */
.pacman.right.moving:not(.invincible) { 
    animation: pacman-breathing-right 0.3s ease-in-out infinite;
}
.pacman.left.moving:not(.invincible) { 
    animation: pacman-breathing-left 0.3s ease-in-out infinite;
}
.pacman.up.moving:not(.invincible) { 
    animation: pacman-breathing-up 0.3s ease-in-out infinite;
}
.pacman.down.moving:not(.invincible) { 
    animation: pacman-breathing-down 0.3s ease-in-out infinite;
}

/* Обычные повороты без анимации */
.pacman.right { transform: scaleX(1); }
.pacman.left { transform: scaleX(-1); }
.pacman.up { transform: rotate(-90deg); }
.pacman.down { transform: rotate(90deg); }

/* Мигание с сохранением поворота - объединяем opacity и transform */
@keyframes blink-right {
    0%, 49% { opacity: 1; transform: scaleX(1); }
    50%, 100% { opacity: 0.3; transform: scaleX(1); }
}
@keyframes blink-left {
    0%, 49% { opacity: 1; transform: scaleX(-1); }
    50%, 100% { opacity: 0.3; transform: scaleX(-1); }
}
@keyframes blink-up {
    0%, 49% { opacity: 1; transform: rotate(-90deg); }
    50%, 100% { opacity: 0.3; transform: rotate(-90deg); }
}
@keyframes blink-down {
    0%, 49% { opacity: 1; transform: rotate(90deg); }
    50%, 100% { opacity: 0.3; transform: rotate(90deg); }
}

/* Мигание ВО ВРЕМЯ неуязвимости - перекрывает всё остальное */
.pacman.invincible.right {
    animation: blink-right 0.3s infinite !important;
}
.pacman.invincible.left {
    animation: blink-left 0.3s infinite !important;
}
.pacman.invincible.up {
    animation: blink-up 0.3s infinite !important;
}
.pacman.invincible.down {
    animation: blink-down 0.3s infinite !important;
}

        /* Враги с разными скинами */
        .enemy {
            position: absolute;
            width: 32px;
            height: 32px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 8;
        }

        .enemy-0 {
            background-image: url('./images/ghost_1.png'); /* Замените на вашу первую ссылку */
        }

        .enemy-1 {
            background-image: url('./images/ghost_2.png'); /* Замените на вашу вторую ссылку */
        }

        .enemy-2 {
            background-image: url('./images/ghost_3.png'); /* Замените на вашу третью ссылку */
        }

        .enemy-3 {
            background-image: url('./images/ghost_4.png'); /* Замените на вашу четвертую ссылку */
        }

        .controls {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 16px;
            padding: 15px;
            text-align: center;
        }

        .control-title {
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .arrow-controls {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .arrow-btn {
            position: absolute;
            width: 60px;
            height: 60px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            font-size: 0;
            background-color: transparent;
        }

        .arrow-btn:hover {
            transform: translateY(0px);
        }


        /* Обычное состояние кнопок */
        .arrow-up {
                top: -20px;
    left: 30px;
            background-image: url('./images/top_off.png');
        }

        .arrow-left {
                top:20px;
    left: -60px;
            background-image: url('./images/left_off.png');
        }

        .arrow-down {
            top: 60px;
    left: 30px;
            background-image: url('./images/bottom_off.png');
        }

        .arrow-right {
            top: 20px;
    left: 126px;
            background-image: url('./images/right_off.png');
        }

        /* Нажатое состояние кнопок */
        .arrow-up.pressed {
            background-image: url('./images/top_on.png') !important;
        }

        .arrow-left.pressed {
            background-image: url('./images/left_on.png') !important;
        }

        .arrow-down.pressed {
            background-image: url('./images/bottom_on.png') !important;
        }

        .arrow-right.pressed {
            background-image: url('./images/right_on.png') !important;
        }

        .score-info {
            display: flex;
            justify-content: space-between;
            color: #FFD700;
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* Точки для сбора */
        .dot {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #FEB3C3;
            border-radius: 50%;
            z-index: 5;
        }

        /* Экран окончания игры */
        .game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #FFD700;
        }

        .game-over h2 {
            font-size: 32px;
            margin-bottom: 15px;
            color: #FF0000;
        }

        .game-over p {
            font-size: 18px; /* добавить если нет */
            margin-bottom: 15px;
            padding: 0 10px;
        }

        .restart-btn {
            padding: 12px 24px;
            font-size: 18px;
            background: linear-gradient(145deg, #333, #222);
            border: 2px solid #FFD700;
            color: #FFD700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .restart-btn:hover {
            background: linear-gradient(145deg, #444, #333);
            transform: translateY(-2px);
        }

        /* Стартовый экран */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #FFD700;
        }

        .start-screen h1 {
            font-size: 36px;
            margin-bottom: 15px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .start-screen p {
            font-size: 16px;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 10px; 
        }

        .start-btn {
            padding: 12px 24px; /* было 15px 30px */
            font-size: 18px; /* было 24px */
            background: linear-gradient(145deg, #333, #222);
            border: 2px solid #FFD700;
            color: #FFD700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-btn:hover {
            background: linear-gradient(145deg, #444, #333);
            transform: translateY(-2px);
        }

        /* Power-up (ускорение) */
        .speed-powerup {
            position: absolute;
            width: 16px;
            height: 16px;
            background: #90EE90;
            border-radius: 50%;
            z-index: 9;
            box-shadow: 0 0 10px #90EE90;
            animation: pulse 1s ease-in-out infinite alternate;
        }

        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.2); }
        }

        /* Жизни */
        .lives-container {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        /* Жизни */
        .heart {
            width: 28px;
            height: 24px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: inline-block;
        }

        .heart.active {
            background-image: url('./images/heart_on.svg');
        }

        .heart.inactive {
            background-image: url('./images/heart_off.svg');
        }

        .pink-dot {
            position: absolute;
            width: 28px;
            height: 22px;
            background-image: url('./images/006.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            z-index: 9;
            filter: drop-shadow(0 0 15px #FF69B4) drop-shadow(0 0 25px #FF1493);
            animation: pulse-simple 1s ease-in-out infinite alternate;
            will-change: transform;
            transform: translateZ(0);
        }

        @keyframes pulse-simple {
            0% { transform: scale(1) translateZ(0); }
            100% { transform: scale(1.2) translateZ(0); }
        }

        /* Экран победы */
        .win-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 100, 0, 0.9);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: #FFD700;
        }

        .win-screen h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #FFD700;
            text-align: center;
            padding: 0 20px;
        }

        .win-screen p {
            font-size: 18px;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>
    <div class="game-container">
        <!-- Игровое поле -->
        <div class="game-field">
            <div class="maze">
                <!-- Внешние стены -->
                <div class="wall-h outer-wall-top"></div>
                <div class="wall-h outer-wall-bottom"></div>
                <div class="wall-v outer-wall-left"></div>
                <div class="wall-v outer-wall-right"></div>
                
                <!-- Внутренние стены лабиринта -->
                <div class="wall-h inner-wall-1"></div>
                <div class="wall-h inner-wall-2"></div>
                <div class="wall-v inner-wall-3"></div>
                <div class="wall-v inner-wall-4"></div>
                
                <div class="wall-h inner-wall-5"></div>
                <div class="wall-v inner-wall-6"></div>
                <div class="wall-v inner-wall-7"></div>
                
                <div class="wall-v inner-wall-8"></div>
                <div class="wall-v inner-wall-9"></div>
                
                <div class="wall-h inner-wall-10"></div>
                <div class="wall-h inner-wall-11"></div>
                
                <div class="wall-h inner-wall-12"></div>
                <div class="wall-h inner-wall-13"></div>
                
                <div class="wall-h inner-wall-14"></div>

                <!-- Стартовый экран -->
                <div class="start-screen" id="start-screen">
                    <h1>Сплитование</h1>
                    <p>Собирай точки и избегай врагов!</p>
                    <p>Управление: стрелки или WASD</p>
                    <button class="start-btn" onclick="startGame()">НАЧАТЬ ИГРУ</button>
                </div>

                <!-- Экран окончания игры -->
                <div class="game-over" id="game-over">
                    <h2>ИГРА ОКОНЧЕНА!</h2>
                    <p>Ваш счёт: <span id="final-score">0</span></p>
                    <button class="restart-btn" onclick="restartGame()">НАЧАТЬ ЗАНОВО</button>
                </div>

                <!-- Экран победы -->
                <div class="win-screen" id="win-screen">
                    <h2>ВЫ ВЫИГРАЛИ СУПЕР ОФФЕР!</h2>
                    <p>Сплитуйте покупки на 6 месяцев без переплат</p>
                    <p>Ваш счёт: <span id="win-score">0</span></p>
                    <button class="restart-btn" onclick="restartGame()">НАЧАТЬ ЗАНОВО</button>
                </div>
                                
                <!-- Pac-Man -->
                <div class="pacman right" id="pacman"></div>
            </div>
        </div>

        <!-- Панель управления -->
        <div class="controls">
            <div class="score-info">
                <span>СЧЁТ: 0</span>
                    <div class="lives-container" id="lives-container">
                        <!-- Сердечки добавляются через JavaScript -->
                    </div>
            </div>
            
            
            <div class="arrow-controls">
                <button class="arrow-btn arrow-up" data-direction="up">▲</button>
                <button class="arrow-btn arrow-left" data-direction="left">◄</button>
                <button class="arrow-btn arrow-down" data-direction="down">▼</button>
                <button class="arrow-btn arrow-right" data-direction="right">►</button>
            </div>
        </div>
    </div>

    <script>
        // Игровые переменные
        const pacman = document.getElementById('pacman');
        const gameField = document.querySelector('.game-field');
        let pacmanX = 170;
        let pacmanY = 185;
        let direction = null;
        let isMoving = false;
        let gameLoop;
        let lives = 3;
        let isInvincible = false;
        let pinkDot = null;
        let allDotsCollected = false;

        const PACMAN_SIZE = 32;
        let MOVE_SPEED = 2; // Эта переменная должна быть объявлена ДО originalSpeed
        const FIELD_PADDING = 20;
        const FIELD_SIZE = 360;
        const FIELD_HEIGHT = 400;

        // Power-up переменные - ПОСЛЕ объявления MOVE_SPEED
        let speedPowerupUsed = false;
        let speedPowerupActive = false;
        let speedPowerup = null;
        let originalSpeed = MOVE_SPEED; // Теперь MOVE_SPEED уже объявлена

        // Остальные переменные
        let gameActive = true;
        let gameStarted = false;
        let score = 0;
        const DOT_SIZE = 4;
        const DOT_SPACING = 20;
        const dots = [];
        const enemies = [];
        const ENEMY_SIZE = 32;
        const ENEMY_SPEED = 1.2;
        const ENEMY_COUNT = 4;



        // Функция запуска игры
        function startGame() {
            gameStarted = true;
            gameActive = true;
            lives = 3; 
            updateLives(); 
            document.getElementById('start-screen').style.display = 'none';
            
            // Инициализация игры
            initPacman();
            createDots();
            createEnemies();
            createSpeedPowerup();
        }

        // Предзагрузка изображений
function preloadImages() {
    const imageUrls = [
        // Pac-Man
        'https://i.ibb.co/PGx61jWg/Watermelon.png',
        
        // Враги (замените на ваши ссылки)
        'https://i.ibb.co/84NnMSpY/Image.png',
        'https://i.ibb.co/9mNkw8jy/Image-1.png',
        'https://i.ibb.co/Df1NYN5y/Image-3.png', 
        'https://i.ibb.co/vxSfFmzM/Image-2.png',
        
        // Кнопки обычные (замените на ваши ссылки)
        'https://i.ibb.co/zT7NtYhW/Property-1-top-off.png',
        'https://i.ibb.co/cGvz99F/Property-1-left-off.png',
        'https://i.ibb.co/qLPtGxM4/Property-1-top-off-1.png',
        'https://i.ibb.co/d0nrvYDH/Property-1-right-off.png',
        
        // Кнопки нажатые
        'https://i.ibb.co/RpJjyyG0/Property-1-top-on.png',
        'https://i.ibb.co/BvtHBZG/Property-1-left-on.png',
        'https://i.ibb.co/qHqpnJ2/Property-1-top-on-1.png',
        'https://i.ibb.co/NgrN2fhM/Property-1-right-on.png'
    ];
    
    const promises = imageUrls.map(url => {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(img);
            img.onerror = () => reject(new Error(`Не удалось загрузить: ${url}`));
            img.src = url;
        });
    });
    
    return Promise.all(promises);
}
        
        // Инициализация позиции Pac-Man'а
        function initPacman() {
            pacman.style.left = pacmanX + 'px';
            pacman.style.top = pacmanY + 'px';
        }

        // Создание точек на карте
        function createDots() {
            const dotsContainer = document.createElement('div');
            dotsContainer.id = 'dots-container';
            gameField.appendChild(dotsContainer);
            
            for (let x = FIELD_PADDING + DOT_SPACING; x < FIELD_SIZE - FIELD_PADDING; x += DOT_SPACING) {
                 for (let y = FIELD_PADDING + DOT_SPACING; y < FIELD_HEIGHT - FIELD_PADDING; y += DOT_SPACING) { // используем FIELD_HEIGHT
                    // Проверяем, не пересекается ли точка со стеной
                    if (!checkDotWallCollision(x, y)) {
                        const dot = document.createElement('div');
                        dot.className = 'dot';
                        dot.style.left = (x - DOT_SIZE/2) + 'px';
                        dot.style.top = (y - DOT_SIZE/2) + 'px';
                        dotsContainer.appendChild(dot);
                        dots.push({x: x, y: y, element: dot, collected: false});
                    }
                }
            }
        }

        // Создание врагов
        function createEnemies() {
            const enemyPositions = [
                {x: 305, y: 340},
                {x: 30, y: 340},
                {x: 300, y: 30},
                {x: 30, y: 30}
            ];
            
            for (let i = 0; i < ENEMY_COUNT; i++) {
                const enemy = document.createElement('div');
                enemy.className = 'enemy enemy-' + i; // Добавить индекс к классу
                enemy.id = 'enemy-' + i;
                gameField.appendChild(enemy);
                
                const pos = enemyPositions[i];
                const enemyData = {
                    element: enemy,
                    x: pos.x,
                    y: pos.y,
                    direction: getRandomDirection(),
                    moveCounter: 0,
                        chasing: false // Добавить эту строку
                };
                
                enemy.style.left = enemyData.x + 'px';
                enemy.style.top = enemyData.y + 'px';
                enemies.push(enemyData);
            }
            
            // Запуск движения врагов
            setInterval(moveEnemies, 20); // ~50 FPS
        }

        // Создание power-up ускорения
function createSpeedPowerup() {
    if (speedPowerupUsed) return;
    
    // Случайное время появления (30-60 секунд после начала игры)
    const delay = Math.random() * 30000 + 30000;
    
    setTimeout(() => {
        if (!gameActive || speedPowerupUsed) return;
        
        // Находим случайную свободную позицию
        let x, y;
        let attempts = 0;
        do {
            x = Math.random() * (FIELD_SIZE - 100) + 50;
            y = Math.random() * (FIELD_HEIGHT - 100) + 50; // используем FIELD_HEIGHT
            attempts++;
        } while (checkDotWallCollision(x, y) && attempts < 50);
        
        // Создаем элемент
        const powerupElement = document.createElement('div');
        powerupElement.className = 'speed-powerup';
        powerupElement.style.left = (x - 8) + 'px';
        powerupElement.style.top = (y - 8) + 'px';
        gameField.appendChild(powerupElement);
        
        speedPowerup = {
            element: powerupElement,
            x: x,
            y: y,
            collected: false
        };
        
        // Убираем power-up через 5 секунд если не собран
        setTimeout(() => {
            if (speedPowerup && !speedPowerup.collected) {
                speedPowerup.element.remove();
                speedPowerup = null;
            }
        }, 5000);
        
    }, delay);
}

        // Проверка сбора power-up
        function checkPowerupCollection() {
            if (!speedPowerup || speedPowerup.collected) return;
            
            const pacmanCenterX = pacmanX + PACMAN_SIZE/2;
            const pacmanCenterY = pacmanY + PACMAN_SIZE/2;
            
            const distance = Math.sqrt(
                Math.pow(pacmanCenterX - speedPowerup.x, 2) + 
                Math.pow(pacmanCenterY - speedPowerup.y, 2)
            );
            
            if (distance < 15) {
                // Собираем power-up
                speedPowerup.collected = true;
                speedPowerup.element.remove();
                speedPowerupUsed = true;
                speedPowerup = null;
                
                // Активируем ускорение
                activateSpeedPowerup();
            }
        }

        // Активация ускорения
        function activateSpeedPowerup() {
            speedPowerupActive = true;
            MOVE_SPEED = originalSpeed * 2; // Удваиваем скорость
            
            console.log('Ускорение активировано!');
            
            // Возвращаем обычную скорость через 10 секунд
            setTimeout(() => {
                MOVE_SPEED = originalSpeed;
                speedPowerupActive = false;
                console.log('Ускорение закончилось');
            }, 5000);
        }

        // Получить случайное направление
        function getRandomDirection() {
            const directions = ['up', 'down', 'left', 'right'];
            return directions[Math.floor(Math.random() * directions.length)];
        }

        // Движение врагов
        function moveEnemies() {
            if (!gameActive) return;
            
            const pacmanCenterX = pacmanX + PACMAN_SIZE/2;
            const pacmanCenterY = pacmanY + PACMAN_SIZE/2;
            
            enemies.forEach(enemy => {
                if (enemy.destroyed) return;
                const enemyCenterX = enemy.x + ENEMY_SIZE/2;
                const enemyCenterY = enemy.y + ENEMY_SIZE/2;
                
                // Вычисляем расстояние до Pac-Man'а
                const distanceToPacman = Math.sqrt(
                    Math.pow(pacmanCenterX - enemyCenterX, 2) + 
                    Math.pow(pacmanCenterY - enemyCenterY, 2)
                );
                
                // Определяем режим поведения
                if (distanceToPacman <= 80 && !isInvincible) {
                    // Режим преследования - двигаемся к Pac-Man'у
                    enemy.chasing = true;
                    enemy.direction = getDirectionToPacman(enemy.x, enemy.y, pacmanX, pacmanY);
                } else if (distanceToPacman >= 140 && enemy.chasing) {
                    // Выход из режима преследования
                    enemy.chasing = false;
                    enemy.direction = getRandomDirection();
                    enemy.moveCounter = 0;
                }
                
                let newX = enemy.x;
                let newY = enemy.y;
                
                switch(enemy.direction) {
                    case 'up':
                        newY -= ENEMY_SPEED;
                        break;
                    case 'down':
                        newY += ENEMY_SPEED;
                        break;
                    case 'left':
                        newX -= ENEMY_SPEED;
                        break;
                    case 'right':
                        newX += ENEMY_SPEED;
                        break;
                }
                
                // Проверяем столкновение со стеной
                if (!checkEnemyWallCollision(newX, newY)) {
                    enemy.x = newX;
                    enemy.y = newY;
                    enemy.element.style.left = enemy.x + 'px';
                    enemy.element.style.top = enemy.y + 'px';
                    enemy.moveCounter++;
                } else {
                    // При столкновении меняем направление
                    if (enemy.chasing) {
                        // Если преследуем, пробуем другое направление к цели
                        enemy.direction = getAlternativeDirectionToPacman(enemy.x, enemy.y, pacmanX, pacmanY);
                    } else {
                        enemy.direction = getRandomDirection();
                    }
                }
                
                // Случайно меняем направление только в обычном режиме
                if (!enemy.chasing && enemy.moveCounter > Math.random() * 100 + 100) {
                    enemy.direction = getRandomDirection();
                    enemy.moveCounter = 0;
                }
            });
        }

        // Получить направление к Pac-Man'у
        function getDirectionToPacman(enemyX, enemyY, pacmanX, pacmanY) {
            const deltaX = pacmanX - enemyX;
            const deltaY = pacmanY - enemyY;
            
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                return deltaX > 0 ? 'right' : 'left';
            } else {
                return deltaY > 0 ? 'down' : 'up';
            }
        }

        // Получить альтернативное направление к Pac-Man'у при столкновении со стеной
        function getAlternativeDirectionToPacman(enemyX, enemyY, pacmanX, pacmanY) {
            const deltaX = pacmanX - enemyX;
            const deltaY = pacmanY - enemyY;
            
            const directions = [];
            
            if (deltaX > 0) directions.push('right');
            if (deltaX < 0) directions.push('left');
            if (deltaY > 0) directions.push('down');
            if (deltaY < 0) directions.push('up');
            
            // Возвращаем случайное направление из возможных
            return directions[Math.floor(Math.random() * directions.length)] || getRandomDirection();
        }

        // Проверка столкновения с врагами
            function checkEnemyCollision() {
                if (!gameActive || isInvincible) return; // Не проверяем если неуязвимы
                
                const pacmanCenterX = pacmanX + PACMAN_SIZE/2;
                const pacmanCenterY = pacmanY + PACMAN_SIZE/2;
                
                enemies.forEach((enemy, index) => {
                    if (enemy.destroyed) return;
                    
                    const enemyCenterX = enemy.x + ENEMY_SIZE/2;
                    const enemyCenterY = enemy.y + ENEMY_SIZE/2;
                    
                    const distance = Math.sqrt(
                        Math.pow(pacmanCenterX - enemyCenterX, 2) + 
                        Math.pow(pacmanCenterY - enemyCenterY, 2)
                    );
                    
                    if (distance < 20) {
                        if (speedPowerupActive) {
                            // Во время ускорения - уничтожаем врага
                            destroyEnemy(enemy, index);
                        } else {
                            // Обычное столкновение - теряем жизнь
                            loseLife();
                        }
                    }
                });
            }

            // Потеря жизни
            function loseLife() {
                lives--;
                updateLives();
                
                if (lives <= 0) {
                    // Все жизни потеряны - конец игры
                    gameOver();
                } else {
                    // Активируем неуязвимость на 3 секунды
                    activateInvincibility();
                }
            }

            // Обновление отображения жизней
            function updateLives() {
                const livesContainer = document.getElementById('lives-container');
                livesContainer.innerHTML = '';
                
                // Показываем 3 сердечка всегда
                for (let i = 0; i < 3; i++) {
                    const heart = document.createElement('span');
                    heart.className = 'heart';
                    
                    if (i < lives) {
                        heart.classList.add('active'); // Живое сердечко
                    } else {
                        heart.classList.add('inactive'); // Потерянное сердечко
                    }
                    
                    livesContainer.appendChild(heart);
                }
            }

            // Активация неуязвимости
            function activateInvincibility() {
                isInvincible = true;
                pacman.classList.add('invincible');
                
                console.log('Неуязвимость активирована на 3 секунды');
                
                // Через 3 секунды убираем неуязвимость
                setTimeout(() => {
                    isInvincible = false;
                    pacman.classList.remove('invincible');
                    console.log('Неуязвимость закончилась');
                }, 3000);
            }

        // Уничтожение врага
        function destroyEnemy(enemy, index) {
            enemy.destroyed = true;
            enemy.element.style.display = 'none';
            enemy.element.style.visibility = 'hidden'; // Дополнительная защита
            console.log('Враг уничтожен!');
        }

        // Окончание игры
        function gameOver() {
            gameActive = false;
            stopPacman();
            
            // Остановка всех врагов
            enemies.forEach(enemy => {
                enemy.direction = null;
            });
            
            // Показать экран окончания игры
            document.getElementById('final-score').textContent = score;
            document.getElementById('game-over').style.display = 'flex';
        }

        // Перезапуск игры
        function restartGame() {

            allDotsCollected = false;
                if (pinkDot && pinkDot.element) {
                    pinkDot.element.remove();
                }
                pinkDot = null;

            lives = 3;
            isInvincible = false;
            pacman.classList.remove('invincible');
            updateLives();

            // Сброс переменных
            gameActive = true;
            score = 0;
            pacmanX = 170;
            pacmanY = 185;
            direction = null;
            isMoving = false;
            gameStarted = true;

            speedPowerupUsed = false;
            speedPowerupActive = false;
            MOVE_SPEED = originalSpeed;
            if (speedPowerup && speedPowerup.element) {
                speedPowerup.element.remove();
            }
            speedPowerup = null;

            
            // Обновление позиции Pac-Man
            initPacman();
            updateScore();
            
            // Сброс точек
            dots.forEach(dot => {
                dot.collected = false;
                dot.element.style.display = 'block';
            });
            
            // Сброс врагов на изначальные позиции
            const enemyPositions = [
                {x: 305, y: 340},
                {x: 30, y: 340},
                {x: 300, y: 30},
                {x: 30, y: 30}
            ];


            enemies.forEach((enemy, index) => {
    
    if (enemy.element) {
        enemy.x = enemyPositions[index].x;
        enemy.y = enemyPositions[index].y;
        enemy.direction = getRandomDirection();
        enemy.moveCounter = 0;
        enemy.chasing = false;
        enemy.destroyed = false;
        
        // Убираем все возможные скрытия
        enemy.element.style.display = '';
        enemy.element.style.visibility = '';
        enemy.element.style.opacity = '';
        enemy.element.className = 'enemy enemy-' + index; // Восстанавливаем класс
        
        enemy.element.style.left = enemy.x + 'px';
        enemy.element.style.top = enemy.y + 'px';
        
    } else {
        console.log(`ОШИБКА: Элемент врага ${index} не найден!`);
    }
});
            
            // Скрыть экран окончания игры
            document.getElementById('game-over').style.display = 'none';
            // Скрыть экран победы
            document.getElementById('win-screen').style.display = 'none';

            gameStarted = true;
            createSpeedPowerup();
        }

        // Проверка столкновения врага со стенами
        function checkEnemyWallCollision(newX, newY) {
            const enemyRect = {
                left: newX,
                top: newY,
                right: newX + ENEMY_SIZE,
                bottom: newY + ENEMY_SIZE
            };
            
            // Проверка границ поля
            if (newX < FIELD_PADDING || 
                newY < FIELD_PADDING || 
                newX + ENEMY_SIZE > FIELD_SIZE - FIELD_PADDING || 
                newY + ENEMY_SIZE > FIELD_HEIGHT - FIELD_PADDING) { // используем FIELD_HEIGHT
                return true;
            }
            
            // Проверка столкновения со стенами лабиринта
            const walls = document.querySelectorAll('.wall-h, .wall-v');
            
            for (let wall of walls) {
                const wallRect = wall.getBoundingClientRect();
                const fieldRect = gameField.getBoundingClientRect();
                
                const wallRelative = {
                    left: wallRect.left - fieldRect.left,
                    top: wallRect.top - fieldRect.top,
                    right: wallRect.right - fieldRect.left,
                    bottom: wallRect.bottom - fieldRect.top
                };
                
                if (enemyRect.left < wallRelative.right &&
                    enemyRect.right > wallRelative.left &&
                    enemyRect.top < wallRelative.bottom &&
                    enemyRect.bottom > wallRelative.top) {
                    return true;
                }
            }
            
            return false;
        }

        // Проверка столкновения точки со стенами
        function checkDotWallCollision(x, y) {
            const dotRect = {
                left: x - DOT_SIZE,
                top: y - DOT_SIZE,
                right: x + DOT_SIZE,
                bottom: y + DOT_SIZE
            };
            
            const walls = document.querySelectorAll('.wall-h, .wall-v');
            
            for (let wall of walls) {
                const wallRect = wall.getBoundingClientRect();
                const fieldRect = gameField.getBoundingClientRect();
                
                const wallRelative = {
                    left: wallRect.left - fieldRect.left,
                    top: wallRect.top - fieldRect.top,
                    right: wallRect.right - fieldRect.left,
                    bottom: wallRect.bottom - fieldRect.top
                };
                
                if (dotRect.left < wallRelative.right &&
                    dotRect.right > wallRelative.left &&
                    dotRect.top < wallRelative.bottom &&
                    dotRect.bottom > wallRelative.top) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Проверка столкновения со стенами
        function checkWallCollision(newX, newY) {
            const pacmanRect = {
                left: newX,
                top: newY,
                right: newX + PACMAN_SIZE,
                bottom: newY + PACMAN_SIZE
            };
            
            // Проверка границ поля
            if (newX < FIELD_PADDING || 
                newY < FIELD_PADDING || 
                newX + PACMAN_SIZE > FIELD_SIZE - FIELD_PADDING || 
                newY + PACMAN_SIZE > FIELD_HEIGHT - FIELD_PADDING) { // используем FIELD_HEIGHT
                return true;
            }
            
            // Проверка столкновения со стенами лабиринта
            const walls = document.querySelectorAll('.wall-h, .wall-v');
            
            for (let wall of walls) {
                const wallRect = wall.getBoundingClientRect();
                const fieldRect = gameField.getBoundingClientRect();
                
                // Преобразуем координаты стены относительно игрового поля
                const wallRelative = {
                    left: wallRect.left - fieldRect.left,
                    top: wallRect.top - fieldRect.top,
                    right: wallRect.right - fieldRect.left,
                    bottom: wallRect.bottom - fieldRect.top
                };
                
                // Проверка пересечения прямоугольников
                if (pacmanRect.left < wallRelative.right &&
                    pacmanRect.right > wallRelative.left &&
                    pacmanRect.top < wallRelative.bottom &&
                    pacmanRect.bottom > wallRelative.top) {
                    return true;
                }
            }
            
            return false;
        }
        
        // Движение Pac-Man'а
        function movePacman() {
            if (!isMoving || !direction) return;
            
            let newX = pacmanX;
            let newY = pacmanY;
            
            switch(direction) {
                case 'up':
                    newY -= MOVE_SPEED;
                    break;
                case 'down':
                    newY += MOVE_SPEED;
                    break;
                case 'left':
                    newX -= MOVE_SPEED;
                    break;
                case 'right':
                    newX += MOVE_SPEED;
                    break;
            }
            
            // Проверяем столкновение
            if (!checkWallCollision(newX, newY)) {
                pacmanX = newX;
                pacmanY = newY;
                pacman.style.left = pacmanX + 'px';
                pacman.style.top = pacmanY + 'px';
                checkDotCollection();
                checkPowerupCollection();
                checkEnemyCollision();
                checkAllDotsCollected();
                checkPinkDotCollection();
            } else {
                // Останавливаемся при столкновении со стеной
                stopPacman();
            }
        }

                    // Проверка сбора точек
            function checkDotCollection() {
                const pacmanCenterX = pacmanX + PACMAN_SIZE/2;
                const pacmanCenterY = pacmanY + PACMAN_SIZE/2;
                
                dots.forEach(dot => {
                    if (!dot.collected) {
                        const distance = Math.sqrt(
                            Math.pow(pacmanCenterX - dot.x, 2) + 
                            Math.pow(pacmanCenterY - dot.y, 2)
                        );
                        
                        if (distance < 14) { // Радиус сбора
                            dot.collected = true;
                            dot.element.style.display = 'none';
                            score += 5;
                            updateScore();
                        }
                    }
                });
            }

            // Проверка сбора всех точек
            function checkAllDotsCollected() {
                const remainingDots = dots.filter(dot => !dot.collected).length;
                
                if (remainingDots === 0 && !allDotsCollected) {
                    allDotsCollected = true;
                    createPinkDot();
                }
            }

            // Создание розового кружка
            function createPinkDot() {
                if (pinkDot) return;
                
                // Находим случайную свободную позицию
                let x, y;
                let attempts = 0;
                do {
                    x = Math.random() * (FIELD_SIZE - 100) + 50;
                    y = Math.random() * (FIELD_HEIGHT - 100) + 50;
                    attempts++;
                } while (checkDotWallCollision(x, y) && attempts < 50);
                
                // Создаем элемент
                const pinkElement = document.createElement('div');
                pinkElement.className = 'pink-dot';
                pinkElement.style.left = (x - 14) + 'px'; // 28/2 = 14
                pinkElement.style.top = (y - 11) + 'px';  // 22/2 = 11
                gameField.appendChild(pinkElement);
                
                pinkDot = {
                    element: pinkElement,
                    x: x,
                    y: y,
                    collected: false
                };
                
                console.log('Розовый кружок появился!');
            }

            // Проверка сбора розового кружка
            function checkPinkDotCollection() {
                if (!pinkDot || pinkDot.collected) return;
                
                const pacmanCenterX = pacmanX + PACMAN_SIZE/2;
                const pacmanCenterY = pacmanY + PACMAN_SIZE/2;
                
                const distance = Math.sqrt(
                    Math.pow(pacmanCenterX - pinkDot.x, 2) + 
                    Math.pow(pacmanCenterY - pinkDot.y, 2)
                );
                
                if (distance < 18) {
                    // Собираем розовый кружок
                    pinkDot.collected = true;
                    pinkDot.element.remove();
                    console.log('Розовый кружок собран!');
                    
                    // TODO: Здесь будет действие после сбора
                    onPinkDotCollected();
                }
            }

            // Действие после сбора розового кружка
            function onPinkDotCollected() {
                console.log('Победа!');
                winGame();
            }

            // Победа в игре
            function winGame() {
                gameActive = false;
                stopPacman();
                
                // Остановка всех врагов
                enemies.forEach(enemy => {
                    enemy.direction = null;
                });
                
                // Показать экран победы
                document.getElementById('win-score').textContent = score;
                document.getElementById('win-screen').style.display = 'flex';
            }

            // Обновление счета
            function updateScore() {
                const scoreElement = document.querySelector('.score-info span');
                scoreElement.textContent = `СЧЁТ: ${score}`;
            }
        
// Запуск движения
function startMoving(newDirection) {
    if (!gameActive || !gameStarted) return;
    direction = newDirection;
    isMoving = true;
    
    // Обновляем внешний вид Pac-Man'а с сохранением invincible
    if (isInvincible) {
        pacman.className = 'pacman ' + direction + ' moving invincible';
    } else {
        pacman.className = 'pacman ' + direction + ' moving';
    }
    
    // Останавливаем предыдущий цикл и запускаем новый
    if (gameLoop) clearInterval(gameLoop);
    gameLoop = setInterval(movePacman, 16); // ~60 FPS
}
        
        // Остановка движения
        function stopPacman() {
            isMoving = false;
            if (gameLoop) {
                clearInterval(gameLoop);
                gameLoop = null;
            }
                // Убираем класс анимации при остановке
            pacman.className = pacman.className.replace(' moving', '');
        }
        
        // Обработчики кнопок управления
        document.querySelectorAll('.arrow-btn').forEach(button => {
    button.addEventListener('click', function() {
        const newDirection = this.getAttribute('data-direction');
        
        // Добавить вибрацию
        if ('vibrate' in navigator) {
            navigator.vibrate(50); // 50ms вибрации
        }

        // Добавить визуальную подсветку при клике мышью
        this.classList.add('pressed');
        setTimeout(() => {
            this.classList.remove('pressed');
        }, 100);
        
        startMoving(newDirection);
    });
});
        // Управление с клавиатуры
        document.addEventListener('keydown', function(event) {
            let newDirection = '';
            switch(event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    newDirection = 'up';
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    newDirection = 'down';
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    newDirection = 'left';
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    newDirection = 'right';
                    break;
            }
            
            if (newDirection) {
                startMoving(newDirection);
                
                // Подсветка соответствующей кнопки
                const button = document.querySelector(`[data-direction="${newDirection}"]`);
                    if (button) {
                        button.classList.add('pressed');
                        setTimeout(() => {
                            button.classList.remove('pressed');
                        }, 150);
                    }
            }
        });
        
        // Инициализация игры
        preloadImages().then(() => {
            console.log('Все изображения загружены!');
            updateLives();
            // НЕ запускаем игру автоматически - только показываем стартовый экран
        }).catch(error => {
            console.error('Ошибка загрузки изображений:', error);
            updateLives();
            // Тоже НЕ запускаем игру автоматически
        });

        // Добавить в конец скрипта
        document.addEventListener('touchstart', function(event) {
            if (event.touches.length > 1) {
                event.preventDefault(); // Отключает pinch-to-zoom
            }
        });

        let lastTouchEnd = 0;
        document.addEventListener('touchend', function(event) {
            const now = (new Date()).getTime();
            if (now - lastTouchEnd <= 300) {
                event.preventDefault(); // Отключает double-tap zoom
            }
            lastTouchEnd = now;
        }, false);

// Добавьте в конец скрипта:
if ('ontouchstart' in window) {
    // Для мобильных устройств используем touchstart
    document.querySelectorAll('.arrow-btn').forEach(button => {
        button.addEventListener('touchstart', function(e) {
            e.preventDefault(); // Предотвращает дублирование click
            const newDirection = this.getAttribute('data-direction');
            
            // Добавляем визуализацию нажатия
            this.classList.add('pressed');
            setTimeout(() => {
                this.classList.remove('pressed');
            }, 100); // Короткая анимация для мобилок
            
            startMoving(newDirection);
        });
    });
} else {
    // Для десктопа оставляем обычные обработчики click
    document.querySelectorAll('.arrow-btn').forEach(button => {
        button.addEventListener('click', function() {
            const newDirection = this.getAttribute('data-direction');
            
            this.classList.add('pressed');
            setTimeout(() => {
                this.classList.remove('pressed');
            }, 150);
            
            startMoving(newDirection);
        });
    });
}
    </script>
</body>
</html>